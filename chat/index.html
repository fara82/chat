<html>
	<div class="users">
		<b>USERS</b>
		<ul id="users"></ul>
	</div>
	<div class="right-pane">
		<h2>Conversation</h2>
		<div class="convo"> 
			<ul id='messages'></ul>

		</div>
		<form id='create-message' action=''></form>
	</div>
	
	<script src='/steal/steal.js'></script>
	<script src='/socket.io/socket.io.js'></script>
	<script>
		steal(
			'chat/create',
			'chat/list',
			'chat/models/message.js',
			'chat/models/user.js',
			'chat/message/create.ejs',
			'chat/message/list.ejs',
			'chat/user/create.ejs',
			'chat/user/list.ejs',
			'chat/chat.less',
			//'./models/fixtures/fixtures.js',
		function(CreateControl, ListControl, Message, User, CreateMessageEJS, ListMessageEJS, CreateUserEJS, ListUserEJS){

			var socket = io.connect('http://localhost:5000'),
				messageList = new Message.List,
				userList = new User.List;

			//on connection to server, ask for user's name with an anonymous callback
			socket.on('connect', function(){
				socket.emit('adduser', prompt("What's your username?"));
			});

			socket.on('loadchat', function(un){

				if (un) {
					// message list control
					new ListControl('#messages', {
						list : messageList,
						template: ListMessageEJS,
						Model: Message
					});

					// user list control
					new ListControl('#users', {
						list : userList,
						template: ListUserEJS,
						Model: User
					});

					// Create message control
					new CreateControl('#create-message', { 
						Model: Message, 
						template: CreateMessageEJS,
						templateOptions: {
							username: un
						} 
					});
				}
			});

			// listener, whenever the server emits 'updatechat', this updates the chat body
			socket.on('updatechat', function () {
				messageList.replace(Message.findAll());
			});

			socket.on('updateusers', function () {
				userList.replace(User.findAll());
			});
		});

	</script>
</html>